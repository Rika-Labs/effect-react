# Effect-React Endgoal Plan (Bun-First)

## Execution Status (2026-02-06)

### Completed Milestones

- M2 - Loader-First `defineApp` + Manifest Runtime Wiring: complete
  - Discovery/runtime integration covered by `src/__tests__/framework-discovery-runtime.integration.test.ts`.
  - Loader and manifest wiring verified through route registry and loader hydration tests.
- M3 - Framework SSR Request Program: complete
  - Unified framework SSR lifecycle through `src/framework/ssrOrchestrator.ts` and server SSR integration.
  - Typed failure channels preserved through adapter boundaries.
- M4 - AST Transform Migration + Safety Suite: complete
  - AST transform path implemented in `src/framework/vite/astTransform.ts`.
  - Safety fixtures/tests present in `src/__tests__/framework-transform-ast.test.ts`.
- M6 - OCP/DRY/KISS Remediation + v1 Readiness: complete
  - Shared server/runtime execution helpers extracted across framework/server/query/mutation/concurrency paths.
  - Effect standards check now guards all `src` production files and first-party `scripts`.
- M5 - Bun-First CLI + Starter Completion: complete
  - CLI `new/dev/build/start` path validated by `src/__tests__/cli-new.test.ts` and `src/__tests__/cli-smoke.test.ts`.
  - Bun adapter and starter path validated by `src/__tests__/adapter-bun.integration.test.ts`.

### Verification Status

- Full gate green with `bun run check`.
- Coverage gate satisfied: branch coverage 90.04% (target >= 90%).
- Effect standards gate green: `effect-standards-ok 171 files`.
- "4th step" in baseline verification (`bun run test`) is included and passing in full check.

## Where You Are Now

You are doing well on the core architecture. The project is already a strong **Effect-first foundation** with unified server pipeline, typed server actions, loader lifecycle state, hydration protocol, Vite plugin, Bun/Node adapters, and 90%+ branch coverage.

Practical readiness toward your goal (Effect + React + Vite as a Next.js alternative):

- Core runtime primitives: **strong**
- Framework composition and DX: **partial**
- Production hardening + extension safety: **not yet complete**

Working estimate: **~65-75% to v1 endgoal**.

## Endgoal Definition

Ship a Bun-first framework where app developers can build full-stack apps using primarily:

- `effect`
- `react`
- `vite`

and get:

- file-route discovery wired to runtime
- first-class loaders/actions/middleware
- framework SSR + hydration orchestration
- robust typed error channels (errors as values)
- CLI lifecycle + starter path (`new/dev/build/start`)

## Standards to Enforce (Non-Negotiable)

- Effect-first internals: Promise only at outer boundary.
- No public `any`; `unknown` only at trust boundaries with immediate decode.
- Prefer errors-as-values/tagged domain errors over thrown exceptions.
- Reduce unsafe casts in core framework/server/router paths.
- Follow CLAUDE/AGENTS guidance consistently (including no-class preference for new architecture code).

## Critical Issues to Address

1. `src/framework/vite.ts` is too brittle (regex/string parser transform).
2. `defineApp` composition is incomplete (route discovery + loader-first integration gaps).
3. SSR is helper-level, not full framework request orchestration.
4. Several internals still rely on Promise/throw patterns where Effect values should carry failures.
5. OCP/DRY/KISS debt in server/action dispatch and Vite plugin monolith.
6. Bun-first DX is close but still lacks polished scaffolded flow + end-to-end app validation.

## Team Workstreams

### Stream A - Runtime Composition

- Own framework composition of routes, loaders, actions, middleware, and request pipeline.
- Make `defineApp` loader-first and manifest-aware.

Primary files:

- `src/framework/app.ts`
- `src/framework/compose.ts` (new)
- `src/server/pipeline.ts`
- `src/router/router.ts`
- `src/router/loader.ts`

### Stream B - Build/Discovery/Transforms

- Split Vite plugin into discovery + transform modules.
- Replace regex transform with AST-based transform and source map support.

Primary files:

- `src/framework/vite.ts`
- `src/framework/vite/discovery.ts` (new)
- `src/framework/vite/astTransform.ts` (new)
- `src/framework/actionRegistry.ts`

### Stream C - SSR/Hydration Orchestration

- Build one framework-level server render pipeline (match -> loaders -> render -> hydration payload).
- Keep streaming/non-streaming consistent under typed error model.

Primary files:

- `src/server/ssr.ts`
- `src/ssr/dehydrate.ts`
- `src/ssr/hydrate.ts`
- `src/framework/ssrOrchestrator.ts` (new)

### Stream D - Bun-First CLI + Starter DX

- Evolve CLI from command wrapper to framework orchestrator.
- Add `new` command and official starter templates.

Primary files:

- `src/cli/index.ts`
- `src/cli/process.ts`
- `src/cli/commands/dev.ts`
- `src/cli/commands/build.ts`
- `src/cli/commands/start.ts`
- `src/cli/commands/new.ts` (new)
- `src/cli/starter/*` (new)

### Stream E - Quality + Release Readiness

- Guardrail tests/docs/release policy.
- Enforce architecture constraints and prevent regression.

Primary files:

- `src/__tests__/*`
- `docs/API.md`
- `docs/parity/MIGRATION-MAP.md`
- `docs/guides/*` (new)
- `package.json`

## Milestones

### M1 - Architecture Hardening and Contract Freeze

Deliverables:

- Add explicit framework contracts for manifests, loader execution, SSR orchestration.
- Break Vite monolith into smaller modules (even before AST swap).
- Define typed framework error ADTs and error mapping policy.

Exit criteria:

- Core contracts documented and referenced in code.
- No new core code introduced with class-based error style.
- `bun run check` green.

### M2 - Loader-First `defineApp` + Manifest Runtime Wiring

Deliverables:

- `defineApp` accepts/propagates loaders and discovered route/action manifests.
- Route discovery feeds runtime route tree without manual glue.

Exit criteria:

- Full app works from discovered modules.
- Loader state/hydration path works through framework entry API.

### M3 - Framework SSR Request Program

Deliverables:

- Add one Effect program for SSR request lifecycle.
- Remove remaining throw-based internal SSR control flow where possible.

Exit criteria:

- SSR and hydration run from one framework API, not scattered helpers.
- Typed failure channels preserved to boundary adapter.

### M4 - AST Transform Migration + Safety Suite

Deliverables:

- Replace string transform with AST transform.
- Add fixture corpus for transform edge cases.

Exit criteria:

- Transform correctness across alias imports, multiline calls, nested args, comments/strings.
- No regressions in existing transform behavior.

### M5 - Bun-First CLI + Starter Completion

Deliverables:

- Implement `effect-react new` with a full-stack starter.
- Ensure Bun-first docs and golden path are runnable.

Exit criteria:

- `bunx effect-react new my-app && bun run dev/build/start` works end-to-end.

### M6 - OCP/DRY/KISS Remediation + v1 Readiness

Deliverables:

- Remove duplicated run/exit/failure logic in server action dispatch.
- Reduce unsafe casts in framework/server/router hot paths.
- Final API/docs cleanup and migration guide depth.

Exit criteria:

- Critical debt list closed.
- Release gates pass with no temporary relaxations.

## OCP/Extensibility Fix Plan

- Replace hardcoded pipeline branching with pluggable request handlers.
- Introduce extension points for plugin discovery/transforms.
- Decouple framework composition from specific route/action source format.

## DRY/KISS Fix Plan

- Extract shared server action execution/classification helper.
- Consolidate CLI option mapping helpers.
- Split large modules (`vite.ts`, potentially `QueryCache.ts` follow-up) into focused units.

## Effectfulness and Error-Value Fix Plan

- Convert remaining async-heavy internals in framework/server/router paths into Effect programs.
- Keep Promise wrappers only at adapter/interop boundaries.
- Replace thrown defects and `Cause.pretty` leakage in HTTP responses with controlled error envelopes.

## File-Level Change Map

### High-priority existing files

- `src/framework/app.ts`
- `src/framework/vite.ts`
- `src/framework/actionRegistry.ts`
- `src/server/actions.ts`
- `src/server/http.ts`
- `src/server/pipeline.ts`
- `src/server/ssr.ts`
- `src/router/router.ts`
- `src/router/loader.ts`
- `src/cli/index.ts`
- `src/cli/process.ts`
- `src/adapters/node/index.ts`
- `docs/API.md`
- `README.md`
- `package.json`

### New files (planned)

- `src/framework/compose.ts`
- `src/framework/ssrOrchestrator.ts`
- `src/framework/vite/discovery.ts`
- `src/framework/vite/astTransform.ts`
- `src/cli/commands/new.ts`
- `src/cli/starter/template.ts`
- `src/__tests__/framework-ssr-e2e.test.tsx`
- `src/__tests__/framework-discovery-runtime.integration.test.ts`
- `src/__tests__/framework-transform-ast.test.ts`
- `docs/guides/BUN-FIRST-QUICKSTART.md`
- `docs/guides/MIGRATE-FROM-NEXTJS.md`

## Verification Plan

### Baseline gates per change set

1. `bun run format:check`
2. `bun run lint`
3. `bun run typecheck`
4. `bun run test`

### Full gate

1. `bun run check`

### Targeted suites to expand and keep green

1. `bun run vitest run src/__tests__/pipeline.integration.test.tsx`
2. `bun run vitest run src/__tests__/loader-ssr-hydration.integration.test.tsx`
3. `bun run vitest run src/__tests__/framework-vite.test.ts`
4. `bun run vitest run src/__tests__/cli-smoke.test.ts`
5. `bun run vitest run src/__tests__/adapter-bun.integration.test.ts`

### New release validation

1. Scaffold + run starter on Bun (`new`, `dev`, `build`, `start`).
2. Validate SSR + loader hydration + server action roundtrip in browser flow.
3. Validate transform edge corpus and manifest mismatch failures.

## Risks and Mitigations

- AST migration delay.
  - Mitigation: incremental parser-first refactor, keep compatibility fixtures.
- Runtime contract drift between plugin manifests and framework runtime.
  - Mitigation: typed manifest schema + integration tests.
- Bun-first focus causing Node regressions.
  - Mitigation: keep Node compatibility suite as secondary required check.
- Coverage gaming instead of meaningful validation.
  - Mitigation: add scenario/e2e tests, not just branch-targeted units.

## v1 Bun-First Definition of Done

- Bun-first app lifecycle works from scaffold to production start.
- Framework composition is manifest-driven and loader-first.
- SSR/hydration orchestration is end-to-end and Effect-native internally.
- Vite transform is AST-based and resilient.
- Typed error channels are preserved through server/client boundaries.
- Architecture constraints are enforced and documented.
- `bun run check` remains green with branch coverage >= 90%.
